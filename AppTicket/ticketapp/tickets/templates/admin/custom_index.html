{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .chart-canvas {
    max-height: 300px;
    min-height: 250px;
  }
</style>
{% endblock %}

{% block title %}Thống kê & Báo cáo{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="fw-bold text-primary mb-4">Thống kê & Báo cáo</h2>

    <div class="row g-4">
        <!-- Cột trái: Số lượng vé bán ra -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white fw-semibold">Số lượng vé bán ra theo loại vé</div>
                <div class="card-body">
                    <label for="eventSelect" class="form-label">Chọn sự kiện:</label>
                    <select id="eventSelect" class="form-select mb-3">
                        <option selected disabled>-- Chọn sự kiện --</option>
                        {% for e in event_ends %}
                            <option value="{{ e.id }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                    <canvas id="ticketChart" class="chart-canvas w-100"></canvas>
                </div>
            </div>
        </div>

        <!-- Cột phải: Doanh thu -->
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white fw-semibold">Doanh thu theo sự kiện</div>
                <div class="card-body">
                    <canvas id="revenueChart" class="chart-canvas w-100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Mức độ quan tâm full-width dưới cùng -->
    <div class="row mt-4">
        <div class="col-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark fw-semibold">Mức độ quan tâm (Lượt xem & Yêu thích)</div>
                <div class="card-body d-flex justify-content-center">
                    <canvas id="interestChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload = function () {
        const select = document.getElementById("eventSelect");
        let ticketChart = null;

        select.addEventListener("change", function () {
            const eventId = this.value;

            fetch(`/stats/tickets/${eventId}/`)
                .then(res => res.json())
                .then(res => {
                    let labels = res.map(item => item.name);
                    let data = res.map(item => item.total);
                    updateTicketChart(labels, data);
                });
        });

        function updateTicketChart(labels, data) {
            if (ticketChart) ticketChart.destroy();

            const ctx = document.getElementById('ticketChart').getContext('2d');
            ticketChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vé bán ra',
                        data: data,
                        backgroundColor: '#0d6efd',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        updateTicketChart([], []);
    };

    let dataRevenue = [];
    let labelsRevenue = [];

    {% for s in revenue_data %}
        dataRevenue.push({{ s.revenue }});
        labelsRevenue.push('{{ s.name }}');
    {% endfor %}

    new Chart(document.getElementById('revenueChart'), {
        type: 'bar',
        data: {
            labels: labelsRevenue,
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: dataRevenue,
                backgroundColor: '#198754',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    let dataInterest = [];
    let labelsInterest = [];

    {% for s in interest_data %}
        dataInterest.push({{ s.total_quantity }});
        labelsInterest.push('{{ s.name }}');
    {% endfor %}

    const colors = [
          '#f6c23e', '#e74a3b', '#36a2eb', '#4bc0c0', '#9966ff',
          '#ff9f40', '#ff6384', '#8e44ad', '#2ecc71', '#e67e22'
        ];
    const backgroundColors = dataInterest.map((_, i) => colors[i % colors.length]);
    new Chart(document.getElementById('interestChart'), {
        type: 'doughnut',
        data: {
            labels: labelsInterest,
            datasets: [{
                label: 'Lượt mua',
                data: dataInterest,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}
